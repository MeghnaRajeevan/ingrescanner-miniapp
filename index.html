<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ingrescanner â€“ Live Barcode</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
  <style>
    body { margin:0; font-family:system-ui; background:#000; color:#fff; height:100vh; overflow:hidden; }
    #container { position:relative; width:100%; height:100%; }
    #video { width:100%; height:100%; object-fit:cover; }
    #overlay { position:absolute; inset:0; pointer-events:none; display:flex; flex-direction:column; justify-content:space-between; padding:20px; }
    #header { text-align:center; background:rgba(0,0,0,0.6); padding:12px; border-radius:12px; backdrop-filter:blur(4px); }
    #guide { position:absolute; inset:0; margin:auto; width:85%; height:45%; border:4px solid #00ff9d; border-radius:16px; box-shadow:0 0 0 9999px rgba(0,0,0,0.6); }
    #result { text-align:center; background:rgba(0,0,0,0.7); padding:16px; border-radius:12px; font-size:1.2rem; margin-top:auto; }
    #close-btn { position:absolute; top:16px; right:16px; background:#ff3b30; color:white; border:none; padding:12px 20px; border-radius:10px; font-weight:bold; z-index:100; cursor:pointer; }
  </style>
</head>
<body>
  <div id="container">
    <video id="video" autoplay playsinline muted></video>
    <div id="overlay">
      <div id="header">
        <h2>Scan Food Barcode</h2>
        <p>Align barcode inside green frame - hold steady!</p>
      </div>
      <div id="guide"></div>
      <div id="result">Loading camera...</div>
      <button id="close-btn">Close</button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const video = document.getElementById('video');
    const resultDiv = document.getElementById('result');
    const closeBtn = document.getElementById('close-btn');

    closeBtn.onclick = () => tg.close();

    Quagga.init({
      inputStream: {
        name: "Live",
        type: "LiveStream",
        target: video,
        constraints: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      },
      locator: {
        patchSize: "xlarge",  // More sensitive for larger/curved barcodes
        halfSample: true
      },
      numOfWorkers: navigator.hardwareConcurrency || 4,
      frequency: 30,  // Scan faster
      decoder: {
        readers: ["ean_reader", "upc_reader", "code_128_reader", "code_39_reader"]
      },
      locate: true
    }, (err) => {
      if (err) {
        resultDiv.textContent = "Scanner error: " + err;
        return;
      }
      Quagga.start();
      resultDiv.textContent = "Scanning... Hold steady!";
    });

    Quagga.onDetected((data) => {
      const code = data.codeResult.code;
      resultDiv.textContent = `Detected: ${code}`;
      console.log("Sending to bot:", code);
      tg.sendData(code);
      setTimeout(() => {
        Quagga.stop();
        tg.close();
      }, 1500);
    });

    Quagga.onProcessed((result) => {
      if (result && result.boxes) {
        resultDiv.textContent = "Trying to read... (" + result.boxes.length + " lines found)";
      }
    });
  </script>
</body>
</html>
